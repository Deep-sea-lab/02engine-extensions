// æ­¤æ–‡ä»¶/ä»£ç åº“ ç”± Github:kms413 åˆ›ä½œï¼Œé‡‡ç”¨ CC-BY_NC-SA 4.0 è®¸å¯åè®®å‘å¸ƒã€‚
// è®¸å¯è¯¦æƒ…ï¼šhttps://creativecommons.org/licenses/[åè®®ä»£ç ]/4.0/

// å®Œæ•´æºä»£ç è§: https://github.com/kms413/scratch-kmsblur

// è¯·æ³¨æ„ï¼šæœ¬ä»£ç åº“ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œè¯·å‹¿ç”¨äºŽå•†ä¸šç”¨é€”ã€‚

!function(){const{vm:{runtime:{renderer:a}},BlockType:e,ArgumentType:t}=Scratch,i=vm.runtime;Scratch.extensions.register(i.kmsBlur=new class{constructor(){this.blurMap=new Map,this.blurValueMap=new Map,this.originalSkins=new Map,i.on("PROJECT_STOP",this.clearCache.bind(this))}getInfo(){return{name:"ð™†ð™¢ð™¨ ð˜½ð™¡ð™ªð™§",id:"KMSBLUR",color1:"#668cff",color2:"#3d6dff",color3:"#7c9dff",blockIconURI:"data:image/svg+xml;charset=utf-8;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIxMjMuMDE4NTciIGhlaWdodD0iNzcuODM1NDEiIHZpZXdCb3g9IjAsMCwxMjMuMDE4NTcsNzcuODM1NDEiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xODAuMjQ3NDcsLTEzNi41ODExNykiPjxnIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIj48cGF0aCBkPSJNMjE1LjkyMTY0LDE1NS44MjE0OWwtMjguNDI0MTYsMTguNzg4MTUiIHN0cm9rZT0iIzhjOWJmZiIgc3Ryb2tlLXdpZHRoPSIxNC41Ii8+PHBhdGggZD0iTTIxMS4zNzUzNywxOTguOTE1NDlsLTIzLjg3Nzg5LC0yNC4zMDU4NCIgc3Ryb2tlPSIjOGM5YmZmIiBzdHJva2Utd2lkdGg9IjE0LjUiLz48cGF0aCBkPSJNMjExLjM3NTM3LDE5OC45MTU0OWwtMjMuODc3ODksLTI0LjMwNTg0IiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iNC41Ii8+PHBhdGggZD0iTTIxNS45MjE2NCwxNTUuODIxNDlsLTI4LjQyNDE2LDE4Ljc4ODE1IiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iNC41Ii8+PGc+PHBhdGggZD0iTTI1NC40NjkyMSwxNDMuODMxMTdsLTI1LjE0NjMxLDYzLjMzNTQxIiBzdHJva2U9IiM4YzliZmYiIHN0cm9rZS13aWR0aD0iMTQuNSIvPjxwYXRoIGQ9Ik0yNTQuNDY5MjEsMTQzLjgzMTE3bC0yNS4xNDYzMSw2My4zMzU0MSIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjQuNSIvPjwvZz48cGF0aCBkPSJNMjY5LjUzMDM2LDE1Ny4yMDg5OWwyNi40ODU2OCwyMS40MzQ0NiIgc3Ryb2tlPSIjOGM5YmZmIiBzdHJva2Utd2lkdGg9IjE0LjUiLz48cGF0aCBkPSJNMjY5LjkxMTQ3LDIwMC41NDA0NWwyNi4xMDQ1OCwtMjEuODk3IiBzdHJva2U9IiM4YzliZmYiIHN0cm9rZS13aWR0aD0iMTQuNSIvPjxwYXRoIGQ9Ik0yNjkuOTExNDcsMjAwLjU0MDQ1bDI2LjEwNDU4LC0yMS44OTciIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSI0LjUiLz48cGF0aCBkPSJNMjY5LjUzMDM2LDE1Ny4yMDg5OWwyNi40ODU2OCwyMS40MzQ0NiIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjQuNSIvPjwvZz48L2c+PC9zdmc+PCEtLXJvdGF0aW9uQ2VudGVyOjU5Ljc1MjUyNDk5OTk5OTk5OjQzLjQxODgzMDAwMDAwMDAxNC0tPg==",blocks:[{opcode:"setBlur",blockType:e.COMMAND,text:"è®¾å®šæ¨¡ç³Šä¸º[blur]px",arguments:{blur:{type:t.NUMBER,defaultValue:5}}},{opcode:"getBlur",blockType:e.REPORTER,text:"å½“å‰æ¨¡ç³Šå€¼(px)"},{opcode:"changeBlur",blockType:e.COMMAND,text:"å¢žåŠ æ¨¡ç³Šå€¼[blur]px",arguments:{blur:{type:t.NUMBER,defaultValue:5}}},{opcode:"returnOriginal",blockType:e.COMMAND,text:"è¿˜åŽŸå›¾åƒ"},{blockType:e.LABEL,text:"å¦‚æžœä½ ä¸çŸ¥é“ä½ åœ¨åšä»€ä¹ˆï¼Œåƒä¸‡ä¸è¦ä½¿ç”¨ä»¥ä¸‹ç§¯æœ¨ï¼"},{opcode:"clearCache",blockType:e.COMMAND,text:"æ¸…é™¤ç¼“å­˜"}]}}_colorData2Canvas(a,e,t){const i=document.createElement("canvas");return i.width=e,i.height=t,i.getContext("2d").putImageData(new ImageData(a,e,t),0,0),i}_getKeyOfMap(a,e){for(const[t,i]of a)if(i===e)return t}setBlur(e,t){let l=t.target,r=this._getKeyOfMap(this.blurMap,a._allDrawables[l.drawableID].skin.id)||l.drawableID,M=this.originalSkins.get(l.drawableID)||a._allDrawables[r].skin,s=this.blurMap.get(r);this.blurMap.get(l.drawableID)!=a._allDrawables[l.drawableID].skin.id&&(r=l.drawableID,M=a._allDrawables[r].skin,s=this.blurMap.get(r),this.originalSkins.set(l.drawableID,M));let{_colorData:I,_width:u,_height:c,_lazyData:d}=M._silhouette,D=d||this._colorData2Canvas(I,u,c),n=M._rotationCenter,N=document.createElement("canvas"),b=N.getContext("2d");N.width=3*M.size[0],N.height=3*M.size[1],b.filter=`blur(${e.blur}px)`,b.drawImage(D,.5*M.size[0],.5*M.size[1],2*M.size[0],2*M.size[1]),n=n.map(((a,e)=>a-.5*M.size[e]+[N.width,N.height][e]/4)),s?a.updateBitmapSkin(s,N,2,n):(s=a.createBitmapSkin(N,2,n),this.blurMap.set(r,s),this.originalSkins.set(l.drawableID,M),a._allSkins[s].kmsBlur=!0),this.blurValueMap.set(l.drawableID,{blur:e.blur,skin:M.id}),a.updateDrawableSkinId(l.drawableID,s),i.requestRedraw()}getBlur(a,e){return this.blurValueMap.get(e.target.drawableID)?.blur||0}changeBlur(a,e){this.setBlur({blur:parseFloat((+this.getBlur({},e)+ +a.blur).toFixed(10))},e)}returnOriginal(e,t){let l=t.target.drawableID,r=(a._allDrawables[l].skin,this.originalSkins.get(l)?.id);r&&(this.blurValueMap.get(l).blur=0,a.updateDrawableSkinId(l,r),i.requestRedraw())}clearCache(){for(let a of i.targets)this.returnOriginal({},{target:a});i.requestRedraw();for(let[e,t]of this.blurMap)a.destroySkin(t);this.blurMap.clear(),this.blurValueMap.clear(),this.originalSkins.clear()}})}();